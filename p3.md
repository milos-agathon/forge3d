# P3 — Shadow system (Hard, PCF, PCSS, VSM/EVSM/MSM, CSM)

**Goal:** Pluggable shadow techniques with resource budgeting.

**Backend**

* Shadow manager:

  * Atlas allocator for 2D shadow maps (D16/24, R32F for VSM/EVSM/MSM).
  * For CSM: N cascades (2–4), per-cascade matrices, stabilized splits.
  * PCSS: fixed blocker search radius/clamped by cascade texel.
  * MSM path with 4th-moment textures or vendor-supported format.
* Memory guardrail: sum of shadow textures ≤ 256 MiB.

**WGSL**

* `shadows.wgsl`:

  * Hard: single depth compare.
  * PCF: 3×3/5×5 kernel with rotating Poisson disk.
  * PCSS: blocker search + penumbra estimation + PCF filter.
  * VSM/EVSM/MSM: depth moments + variance/EVSM warp + Chebyshev; light leak reduction.
  * CSM split selection + texcoord transform with cascade fade.
  * Uniforms:

    ```wgsl
    struct ShadowParamsGPU { technique:u32; map_res:u32; cascades:u32; vsm:u32; }
    @group(1) @binding(0) var shadowTex: texture_depth_2d; // or texture_2d<f32> for VSM/MSM
    @group(1) @binding(1) var shadowSampler: sampler_comparison; // or sampler
    ```
* Integrate with BRDF lighting loop: `visibility = eval_shadow(...)`.

**CLI**

* `--shadows hard|pcf|pcss|vsm|evsm|msm|csm --shadow-map-res 1024 --cascades 4`.

**Acceptance**

* Visual: softening with PCSS; reduced acne; deterministic atlas allocation; perf counter meets 16.6ms @ 1280×920 on mid-range GPU (document your target).

---

