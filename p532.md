**SYSTEM / ROLE**

You are an expert real-time rendering engineer working inside a Rust + wgpu + WGSL codebase that already has a working SSR implementation and a P5/M2 test harness that writes `p5_meta.json`. Your only goal is to make the **SSR glossy stripe test pass** without breaking the other tests.

---

**TASK**

M2 is currently failing with `SSR_STRIPE_FAIL_CONTRAST`. You must:

1. **Fix the SSR glossy stripe test** so that:

   * The stripe test **runs and passes** (no `FAIL` in `status` or `ssr_status` in `p5_meta.json`).
   * `stripe_contrast` is non-empty and both `min_contrast_ref` and `min_contrast_ssr` are above the harness’ contrast threshold (whatever the harness uses; don’t hard-code a guess, just make sure the rendered images clearly have strong stripe contrast).
   * The SSR image visually matches its offline **reference** (no obvious clamp, crush, or banding).

2. **Keep thickness ablation passing**:

   * `thickness_ablation.undershoot_before` and `undershoot_after` must remain `0.0`. 

3. **Do NOT “cheat” by weakening the test**:

   * Do **not** change the stripe analysis logic or thresholds in the test harness.
   * Do **not** bypass SSR or feed fake values into the metrics.
   * All fixes must come from **scene setup and SSR shading/trace logic**, not from loosening the checks.

---

**CONSTRAINTS & DIAGNOSIS**

Use the existing metadata to drive your changes:

1. **Use `p5_meta.json` as ground truth**

   * Read the current file (root of the project or test output directory) and confirm:

     * `status` and `ssr_status` are `"SSR_STRIPE_FAIL_CONTRAST"`.
     * `stripe_contrast` is an empty array.
     * `stripe_analysis.min_contrast_ref == 0.0` and `min_contrast_ssr == 0.0`. 
   * After your changes, re-run the M2 test binary/script until:

     * `status` and `ssr_status` **no longer contain `"FAIL"`**.
     * `stripe_contrast` has at least one element.
     * `min_contrast_ref > 0` and `min_contrast_ssr > 0`.

2. **Scene integrity**

   * Locate the **SSR glossy stripe test scene** (the one that renders the long row of spheres under the bright stripe) and:

     * Restore or enforce the **intended** camera, exposure, environment gradient, stripe light, sphere material and albedo.
     * Remove any ad-hoc tweaks that cause:

       * Completely **blown-out** specular (white discs with cyan rims).
       * Completely **black** spheres.
       * Over-bright emissive rims that don’t look like a reflection of the stripe.
   * The per-sphere specular ring should:

     * Be clearly visible on every sphere.
     * Have a consistent shape and width along the row.
     * Show a smooth, interpretable gradient in average brightness across the 9 sampling regions used by the stripe analysis.

3. **SSR implementation**

   * Find the WGSL shaders that implement SSR (search for functions like `trace_ssr`, `shade_ssr`, `ssr_main`, or similar).
   * Check and, if needed, fix:

     * **Ray direction & view-space math** (correct use of view/projection matrices).
     * **Thickness usage**: rays should stop *before* punching through the geometry; keep the current ablation behaviour that produced zero undershoot.
     * **Roughness / BRDF**: ensure glossy highlights are not artificially clamped or multiplied by arbitrary factors that destroy contrast.
     * **Energy mapping / tonemapping** in the SSR resolve path vs the IBL path so that SSR reflections follow the same exposure and tone curve as the reference.

4. **No regression to other tests**

   * Re-run the entire M2 / P5 SSR test suite (including thickness ablation).
   * Confirm:

     * Thickness ablation metrics remain zero undershoot.
     * Performance counters (`avg_steps`, `total_steps`, `perf_ms`) remain in the same order of magnitude as before; don’t introduce pathological step counts or infinite loops. 

---

**IMPLEMENTATION STEPS (WHAT YOU SHOULD ACTUALLY DO)**

1. **Locate tests & harness**

   * Find the executable/test that generates `p5_ssr_glossy_reference.*`, `p5_ssr_glossy_final.*`, `p5_ssr_thickness_ablation.*` and `p5_meta.json`.
   * Identify where camera, lights, materials, and post-processing for this scene are configured.

2. **Fix the glossy stripe scene**

   * Adjust only **physically reasonable** parameters:

     * Camera position / FOV so the spheres occupy a similar screen space to the spec images.
     * Environment gradient and stripe emissive intensity so that the specular ring is:

       * **Below** full white after tonemapping.
       * Well above the background luminance.
   * If you previously changed these in earlier attempts, revert them to the intended values.

3. **Fix SSR shading if needed**

   * Inspect SSR resolve code for:

     * Manual clamping to [0, 1] too early (before tonemapping).
     * Extra multipliers or bias terms applied only to SSR, not to direct/IBL lighting.
   * Align SSR resolve with the same shading path as the reference image generation (or as close as the engine allows).

4. **Iterate with the metrics**

   * After each change:

     * Rebuild and run the M2/SSR glossy test.
     * Open `p5_meta.json` and verify `stripe_analysis` and `stripe_contrast`.
   * Stop only when:

     * `status` and `ssr_status` don’t contain `"FAIL"`.
     * `stripe_contrast` is populated and both `min_contrast_ref` and `min_contrast_ssr` are strictly positive and visually consistent with a clear, non-blown-out stripe along the spheres.

5. **Document**

   * Add concise comments in the SSR shader and scene setup explaining:

     * Why specific constants (intensity, exposure, thickness) are chosen.
     * How they relate to the M2 glossy stripe test and its contrast requirements.

---

**ACCEPTANCE CRITERIA**

Your work is complete only when ALL of the following are true:

1. Running the M2 / SSR glossy test produces a new `p5_meta.json` where:

   * `status` and `ssr_status` do **not** contain `"FAIL"`.
   * `stripe_contrast` is non-empty.
   * `stripe_analysis.min_contrast_ref > 0` and `stripe_analysis.min_contrast_ssr > 0`. 

2. The rendered images:

   * Show a row of **blue (or chosen color) glossy spheres** with a single, sharp but not blown-out specular ring matching the offline reference.
   * No frame shows fully white discs or fully black spheres.

3. Thickness ablation images remain visually correct and:

   * `thickness_ablation.undershoot_before == 0.0`
   * `thickness_ablation.undershoot_after == 0.0`. 

Only stop once all these conditions are satisfied.
