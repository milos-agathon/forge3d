# P9 — QA: golden images, unit tests, CI matrix

**Goal:** Ensure correctness and cross-platform health.

**Tests**

* WGSL unit kernels (where possible) + Rust shader parameter packing tests.
* Golden image set (~12): combinations of BRDF × shadows × IBL; epsilon SSIM ≥ 0.98 @ 1280×920.
* CI: win_amd64, linux_x86_64, macos_universal2; build with `cmake ≥ 3.24` + cargo + maturin wheel smoke test.
* Example sanity run in CI: render a 640×360 frame for each major mode within 90s.

**Docs**

* “Troubleshooting visuals” with checklists per subsystem.

**Acceptance**

* CI green; golden image diffs stored as artifacts on failure.

---

## Implementation Notes & Guardrails

* **Binding layout:** Keep a stable bind group scheme:

  * `@group(0)`: camera, frame, lights SSBO + counts, shading params.
  * `@group(1)`: shadow maps + samplers + CSM matrices.
  * `@group(2)`: IBL textures + BRDF LUT.
  * `@group(3)+`: material/terrain resources.
* **Precision:** Use `f32` everywhere; clamp roughness ∈ [0.04, 1.0].
* **Normals/Tangents:** Provide MikkTSpace tangents for anisotropy/Disney; fall back gracefully.
* **Area lights:** Stub with uniform surface sampling first; add LTC later (matrix fit tables via texture).
* **Subsurface/Hair:** Implement as **screen-space approximations** initially; mark RT paths as future.
* **Vulkan 1.2 compatibility:** Avoid non-portable WGSL features; ensure equivalent SPIR-V via wgpu.

---

## Example CLI Invocations (ready after P7)

* Outdoor PBR with GI & soft shadows:

  ```
  python examples/terrain_demo.py \
    --light 'type=directional,dir=0.3,0.6,-0.7,intensity=5,color=1,0.98,0.95,tag=sun' \
    --gi ibl,ssao --hdr assets/snow_field_4k.hdr \
    --brdf cooktorrance-ggx --shadows pcss --shadow-map-res 2048 \
    --sky hosek-wilkie --volumetric 'density=0.01,phase=hg,g=0.6' \
    --colormap-domain 200 2200 --output out/pbr_soft.png --overwrite
  ```
* Stylized toon with hard shadows:

  ```
  python examples/terrain_demo.py --preset toon_viz --output out/toon.png
  ```
* Anisotropic Ashikhmin–Shirley with area disk light:

  ```
  python examples/terrain_demo.py \
    --light 'type=area-disk,pos=10,15,8,intensity=35,area=2.0' \
    --brdf ashikhmin-shirley --shadows pcf --output out/area_as.png
  ```

