<task>
  <title>Remediate failed criteria only</title>

  <inputs>
    <repoRoot>.</repoRoot>
    <paths>
      <!-- Rename/move to exact required paths -->
      <path>src/core/render_bundles.rs</path>
      <path>src/core/mod.rs</path>
      <path>python/forge3d/bundles.py</path>
      <path>tests/test_render_bundles.py</path>
      <path>docs/render_bundles.md</path>
    </paths>
  </inputs>

  <plan>
    <!-- 0) Branch & preflight -->
    <step>git checkout -b fix/N4-render-bundles-ssim</step>
    <step>git status --porcelain</step>

    <!-- 1) Path normalization (no semantic changes) -->
    <step>If current file is at src/core/bundles.rs, move it to src/core/render_bundles.rs; update src/core/mod.rs to `pub mod render_bundles;`.</step>
    <step>Rename docs/bundles.md -> docs/render_bundles.md (update any internal links/headings minimally).</step>
    <step>Rename tests/test_bundles.py -> tests/test_render_bundles.py (keep existing tests intact).</step>

    <!-- 2) Minimal API glue for direct vs bundle paths -->
    <step>In python/forge3d/bundles.py, add a small helper `render_direct_vs_bundle(scene_cfg)` that renders the same scene via (a) direct encoder and (b) render bundle, returning two RGB numpy images and timing info. Use native path if available; otherwise deterministic numpy fallback that exercises identical math for both paths.</step>
    <step>Expose a pure-Python SSIM helper (prefer skimage.metrics.structural_similarity if available; else normalized MSE-to-SSIM fallback) to compute SSIM in tests.</step>

    <!-- 3) Tests for AC -->
    <step>Create/augment tests/test_render_bundles.py with:
      - test_ssim_ge_0_995: uses a fixed small scene; calls render_direct_vs_bundle(); computes SSIM and asserts SSIM ≥ 0.995.
      - test_timing_captured: asserts both direct and bundle timing values are present and &gt; 0; also prints them.
      - test_no_validation_warnings: run a minimal render with WGPU validation enabled (env var or logger hook) and assert no "validation error" or "validation warning" appears in captured logs. Skip gracefully if native backend unavailable.</step>

    <!-- 4) Verify -->
    <step>pytest -q tests/test_render_bundles.py::test_ssim_ge_0_995 tests/test_render_bundles.py::test_timing_captured tests/test_render_bundles.py::test_no_validation_warnings -s</step>

    <!-- 5) Commit -->
    <step>git add src/core/render_bundles.rs src/core/mod.rs python/forge3d/bundles.py tests/test_render_bundles.py docs/render_bundles.md</step>
    <step>git commit -m "N4: align deliverable paths; add SSIM ≥0.995 direct-vs-bundle test; assert timing capture; validate no wgpu warnings"</step>
  </plan>

  <deliverables>
    <file>src/core/render_bundles.rs</file>
    <file>python/forge3d/bundles.py</file>
    <file>tests/test_render_bundles.py</file>
    <file>docs/render_bundles.md</file>
  </deliverables>

  <acceptanceCriteria>
    <ac id="AC-N4-SSIM">tests/test_render_bundles.py::test_ssim_ge_0_995 passes and reports SSIM ≥ 0.995 between direct and bundle outputs.</ac>
    <ac id="AC-N4-Timing">tests/test_render_bundles.py::test_timing_captured passes and records non-zero timings for both paths.</ac>
    <ac id="AC-N4-Validation">tests/test_render_bundles.py::test_no_validation_warnings passes with no validation warnings/errors captured from wgpu during a minimal render (skip if native backend unavailable).</ac>
  </acceptanceCriteria>

  <safety>
    <rule>Create branch fix/N4-render-bundles-ssim; small, scoped commits.</rule>
    <rule>No blind search/replace; preserve existing public APIs; keep semantics identical when moving files.</rule>
    <rule>Exclude binary/large outputs: target/, out/, .maturin/, __pycache__/.</rule>
  </safety>

  <constraints>
    <platforms>win_amd64, linux_x86_64, macos_universal2</platforms>
    <gpuMemoryBudgetMiB>512</gpuMemoryBudgetMiB>
    <build>cmake≥3.24 (if applicable), cargo/rustc, PyO3</build>
    <apis>WebGPU/WGSL primary; Vulkan 1.2-compatible design</apis>
    <docs>Sphinx preferred</docs>
  </constraints>

  <completion>
    <summary>N4 deliverables at exact paths; SSIM ≥ 0.995 confirmed; timings captured; no validation warnings.</summary>
    <verify>
      git ls-files src/core/render_bundles.rs python/forge3d/bundles.py tests/test_render_bundles.py docs/render_bundles.md
      pytest -q tests/test_render_bundles.py -s
    </verify>
  </completion>
</task>
