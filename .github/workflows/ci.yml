# A1.8-BEGIN:ci-matrix
name: CI (matrix & artifacts)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read

defaults:
  run:
    shell: bash

jobs:
  test-matrix:
    name: ${{ matrix.os }} | py${{ matrix.python-version }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [windows-latest, ubuntu-latest, macos-latest]
        python-version: ["3.10", "3.11", "3.12", "3.13"]

    env:
      # Needed for Py3.13 with pyo3 0.21 build
      PYO3_USE_ABI3_FORWARD_COMPATIBILITY: "1"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: "pip"

      - name: Install build & test deps
        run: |
          python -m pip install -U pip
          python -m pip install maturin pytest pytest-timeout numpy

      - name: Build extension (editable)
        run: |
          maturin develop --release

      - name: Pytest (fast)
        run: |
          pytest -q

      - name: Determinism harness (sequential)
        run: |
          python python/tools/determinism_harness.py \
            --width 96 --height 96 --runs 3 --png \
            --out-dir determinism_artifacts

      - name: Upload determinism artifacts
        uses: actions/upload-artifact@v4
        with:
          name: determinism_${{ matrix.os }}_py${{ matrix.python-version }}
          path: |
            determinism_artifacts/determinism_report.json
            determinism_artifacts/triangle.png
          retention-days: 7
          if-no-files-found: warn

      # Cross-backend runner can be unreliable on headless Linux; run on Windows/macOS only
      - name: Cross-backend runner (Windows/macOS)
        if: runner.os != 'Linux'
        run: |
          python python/tools/backends_runner.py \
            --runs 1 --out-dir backends_artifacts --png

      - name: Upload backend artifacts (Windows/macOS)
        if: runner.os != 'Linux'
        uses: actions/upload-artifact@v4
        with:
          name: backends_${{ matrix.os }}_py${{ matrix.python-version }}
          path: |
            backends_artifacts/backends_report.json
            backends_artifacts/*.png
          retention-days: 7
          if-no-files-found: warn
# A1.8-END:ci-matrix