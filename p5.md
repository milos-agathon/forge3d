# P5 — Screen-space effects (SSAO/GTAO, SSGI, SSR) as optional passes

**Goal:** Cheap GI/look-dev options with toggles.

**Backend/WGSL**

* GBuffer (positions or depth+reconstruct, normals, material).
* SSAO/GTAO compute pass → bilateral blur; temporal filter optional.
* SSGI: half-res ray march in depth, fall back to diffuse IBL; temporal accumulation.
* SSR: hierarchical Z-buffer or SSR with thickness; fallback to env reflection.

**CLI**

* `--gi ssao` (with options `--ssao-radius`, `--ssao-intensity`)
* `--gi ssgi` (options `--ssgi-steps`, `--ssgi-radius`)
* `--gi ssr` (options `--ssr-max-steps`, `--ssr-thickness`)

**Acceptance**

* AO visibly darkens creases; SSGI adds diffuse bounce on walls; SSR reflects sky & bright objects.

---

## Setup & Usage

- Build the viewer (release recommended for stable timings):
  - `cargo run --release --example interactive_viewer`
- Load assets and environment maps at runtime:
  - `:obj assets/cornell_box.obj`
  - `:ibl /path/to/env.hdr`
- Toggle GI effects and switch visualization as you iterate:
  - `:gi ssao on`, `:gi ssgi on`, `:gi ssr on`
  - `:viz material|normal|depth|gi`
- Capture a PNG snapshot at any time:
  - `:snapshot tests/golden/my_scene.png`

Tip: You can pre-seed commands via CLI in `examples/interactive_viewer.rs` (e.g., `--gi ssao:on --ibl assets/sky.hdr --viz material`). These are forwarded to the same runtime command parser.

## Viewer Command Reference (GI & Debug)

- GI toggles
  - `:gi ssao on|off`
  - `:gi ssgi on|off`
  - `:gi ssr on|off`

- Visualization & depth debug
  - `:viz material|normal|depth|gi`
  - `:viz-depth-max <float>`  Limit depth range when in `depth` viz mode

- SSAO/GTAO parameters
  - `:ssao-technique ssao|gtao`  Choose screen-space AO technique
  - `:ssao-radius <float>`      Sample radius
  - `:ssao-intensity <float>`   Intensity scale
  - `:ssao-composite on|off`    Multiply AO into material color when `:viz material`
  - `:ssao-mul <0..1>`          Composite strength (0 = bypass, 1 = full AO)

- SSGI parameters
  - `:ssgi-steps <u32>`           Ray-march steps
  - `:ssgi-radius <float>`        Max search radius in view space
  - `:ssgi-half on|off`           Half-resolution tracing for performance
  - `:ssgi-temporal-alpha <0..1>` Temporal accumulation factor
  - `:ssgi-edges on|off`          Edge-aware upsample (quality vs. perf)
  - `:ssgi-upsigma <float>`       Depth sigma for edge-aware upsample
  - `:ssgi-normexp <float>`       Normal exponent for edge-aware upsample

- SSR parameters
  - `:ssr-max-steps <u32>`   Max marching steps
  - `:ssr-thickness <float>` Thickness tolerance to avoid undershoots

- IBL and snapshots
  - `:ibl <path.hdr|path.exr>`  Load environment map for `ibl` and to support SSGI/SSR fallbacks
  - `:snapshot [path]`          Write current frame to PNG (default path if omitted)

## Camera & Framing

- Field of view:
  - `:fov <degrees>`  Clamp 1..179 degrees

- Look-at & window size (for consistent golden images):
  - `:cam-lookat ex ey ez tx ty tz [ux uy uz]`
  - `:size <width> <height>`

These commands are used by `scripts/generate_golden_images.py` to ensure consistent framing when producing golden images.

## CLI Flags Cheat Sheet (mapped to Viewer commands)

- General
  - `--gi <ssao:on|ssao:off|ssgi:on|ssgi:off|ssr:on|ssr:off>` → `:gi ...`
  - `--ibl <path>` → `:ibl <path>`
  - `--viz <material|normal|depth|gi>` → `:viz ...`
  - `--snapshot <path>` → `:snapshot <path>`

- SSAO/GTAO
  - `--ssao-technique <ssao|gtao>` → `:ssao-technique ...`
  - `--ssao-radius <float>` → `:ssao-radius ...`
  - `--ssao-intensity <float>` → `:ssao-intensity ...`

- SSGI
  - `--ssgi-steps <u32>` → `:ssgi-steps ...`
  - `--ssgi-radius <float>` → `:ssgi-radius ...`
  - `--ssgi-half <on|off>` → `:ssgi-half ...`
  - `--ssgi-temporal-alpha <float>` → `:ssgi-temporal-alpha ...`

- SSR
  - `--ssr-max-steps <u32>` → `:ssr-max-steps ...`
  - `--ssr-thickness <float>` → `:ssr-thickness ...`

## Acceptance Guidance

- AO creases: Use `assets/cornell_box.obj`, enable SSAO or GTAO, set `:viz material`, and tune with `:ssao-radius`, `:ssao-intensity`, `:ssao-mul`.
- SSGI bounce: Load an IBL (`:ibl`), enable `:gi ssgi on`, and adjust temporal/edge-aware upsample params for quality vs. perf.
- SSR highlights: Use glossy materials and an IBL. Tune `:ssr-max-steps` and `:ssr-thickness`.

