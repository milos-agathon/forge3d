pytest -q  
.....Fs...............FFFFFFFFF.FFs...FF.....................sFFs..                                                                                                                        [100%]
=========================================================================================== FAILURES ============================================================================================ 
____________________________________________________________________________________ test_terrain_validation ____________________________________________________________________________________ 

tmp_path = WindowsPath('C:/Users/milos/AppData/Local/Temp/pytest-of-milos/pytest-66/test_terrain_validation0')

    @pytest.mark.skipif(not hasattr(vf, "TerrainSpike"), reason="terrain feature not built")
    def test_terrain_validation(tmp_path):
        with pytest.raises(ValueError):
            vf.make_terrain(64, 64, 1)  # grid must be >= 2
>       t = vf.make_terrain(64, 48, 16)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests\test_api_validation.py:35:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

width = 64, height = 48, grid = 16

    def make_terrain(width: int, height: int, grid: int = 128):
        """
        Helper constructor for TerrainSpike (only available when the crate
        is built with `--features terrain_spike`).
        """
        if "TerrainSpike" not in globals():
            raise RuntimeError("TerrainSpike unavailable; build crate with --features terrain_spike")
        w, h = size_wh(width, height)
        g = _grid(grid)
>       return TerrainSpike(w, h, g)  # type: ignore[name-defined]
               ^^^^^^^^^^^^^^^^^^^^^
E       pyo3_runtime.PanicException: wgpu error: Validation Error
E       
E       Caused by:
E           In Device::create_shader_module
E             note: label = `vf.Terrain.shader`
E
E       Shader 'vf.Terrain.shader' parsing error: no definition in scope for identifier: 'globals'
E          ┌─ wgsl:99:16
E          │
E       99 │   let dx = max(globals.spacing.x, 1e-8);
E          │                ^^^^^^^ unknown identifier
E       
E       
E           no definition in scope for identifier: 'globals'

python\vulkan_forge\__init__.py:75: PanicException
------------------------------------------------------------------------------------- Captured stderr call -------------------------------------------------------------------------------------- 

thread '<unnamed>' panicked at C:\Users\milos\.cargo\registry\src\index.crates.io-1949cf8c6b5b557f\wgpu-0.19.4\src\backend\wgpu_core.rs:3006:5:
wgpu error: Validation Error

Caused by:
    In Device::create_shader_module
      note: label = `vf.Terrain.shader`

Shader 'vf.Terrain.shader' parsing error: no definition in scope for identifier: 'globals'
   ┌─ wgsl:99:16
   │
99 │   let dx = max(globals.spacing.x, 1e-8);
   │                ^^^^^^^ unknown identifier


    no definition in scope for identifier: 'globals'


note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace
__________________________________________________________________ TestTerrainSpikeIntegration.test_set_camera_look_at_exists ___________________________________________________________________ 

self = <test_camera.TestTerrainSpikeIntegration object at 0x0000023E341EDBD0>

    def test_set_camera_look_at_exists(self):
        """Test that set_camera_look_at method exists."""
>       spike = vf.TerrainSpike(512, 512)
                ^^^^^^^^^^^^^^^^^^^^^^^^^
E       pyo3_runtime.PanicException: wgpu error: Validation Error
E       
E       Caused by:
E           In Device::create_shader_module
E             note: label = `vf.Terrain.shader`
E
E       Shader 'vf.Terrain.shader' parsing error: no definition in scope for identifier: 'globals'
E          ┌─ wgsl:99:16
E          │
E       99 │   let dx = max(globals.spacing.x, 1e-8);
E          │                ^^^^^^^ unknown identifier
E       
E       
E           no definition in scope for identifier: 'globals'

tests\test_camera.py:225: PanicException
------------------------------------------------------------------------------------- Captured stderr call -------------------------------------------------------------------------------------- 

thread '<unnamed>' panicked at C:\Users\milos\.cargo\registry\src\index.crates.io-1949cf8c6b5b557f\wgpu-0.19.4\src\backend\wgpu_core.rs:3006:5:
wgpu error: Validation Error

Caused by:
    In Device::create_shader_module
      note: label = `vf.Terrain.shader`

Shader 'vf.Terrain.shader' parsing error: no definition in scope for identifier: 'globals'
   ┌─ wgsl:99:16
   │
99 │   let dx = max(globals.spacing.x, 1e-8);
   │                ^^^^^^^ unknown identifier


    no definition in scope for identifier: 'globals'


_____________________________________________________________ TestTerrainSpikeIntegration.test_set_camera_look_at_updates_uniforms ______________________________________________________________ 

self = <test_camera.TestTerrainSpikeIntegration object at 0x0000023E341EDD10>

    def test_set_camera_look_at_updates_uniforms(self):
        """Test that set_camera_look_at updates UBO and debug uniforms."""
>       spike = vf.TerrainSpike(512, 512)
                ^^^^^^^^^^^^^^^^^^^^^^^^^
E       pyo3_runtime.PanicException: wgpu error: Validation Error
E       
E       Caused by:
E           In Device::create_shader_module
E             note: label = `vf.Terrain.shader`
E
E       Shader 'vf.Terrain.shader' parsing error: no definition in scope for identifier: 'globals'
E          ┌─ wgsl:99:16
E          │
E       99 │   let dx = max(globals.spacing.x, 1e-8);
E          │                ^^^^^^^ unknown identifier
E       
E       
E           no definition in scope for identifier: 'globals'

tests\test_camera.py:231: PanicException
------------------------------------------------------------------------------------- Captured stderr call -------------------------------------------------------------------------------------- 

thread '<unnamed>' panicked at C:\Users\milos\.cargo\registry\src\index.crates.io-1949cf8c6b5b557f\wgpu-0.19.4\src\backend\wgpu_core.rs:3006:5:
wgpu error: Validation Error

Caused by:
    In Device::create_shader_module
      note: label = `vf.Terrain.shader`

Shader 'vf.Terrain.shader' parsing error: no definition in scope for identifier: 'globals'
   ┌─ wgsl:99:16
   │
99 │   let dx = max(globals.spacing.x, 1e-8);
   │                ^^^^^^^ unknown identifier


    no definition in scope for identifier: 'globals'


___________________________________________________________ TestTerrainSpikeIntegration.test_set_camera_look_at_validates_parameters ____________________________________________________________ 

self = <test_camera.TestTerrainSpikeIntegration object at 0x0000023E342015B0>

    def test_set_camera_look_at_validates_parameters(self):
        """Test that set_camera_look_at validates parameters correctly."""
>       spike = vf.TerrainSpike(512, 512)
                ^^^^^^^^^^^^^^^^^^^^^^^^^
E       pyo3_runtime.PanicException: wgpu error: Validation Error
E       
E       Caused by:
E           In Device::create_shader_module
E             note: label = `vf.Terrain.shader`
E
E       Shader 'vf.Terrain.shader' parsing error: no definition in scope for identifier: 'globals'
E          ┌─ wgsl:99:16
E          │
E       99 │   let dx = max(globals.spacing.x, 1e-8);
E          │                ^^^^^^^ unknown identifier
E       
E       
E           no definition in scope for identifier: 'globals'

tests\test_camera.py:255: PanicException
------------------------------------------------------------------------------------- Captured stderr call -------------------------------------------------------------------------------------- 

thread '<unnamed>' panicked at C:\Users\milos\.cargo\registry\src\index.crates.io-1949cf8c6b5b557f\wgpu-0.19.4\src\backend\wgpu_core.rs:3006:5:
wgpu error: Validation Error

Caused by:
    In Device::create_shader_module
      note: label = `vf.Terrain.shader`

Shader 'vf.Terrain.shader' parsing error: no definition in scope for identifier: 'globals'
   ┌─ wgsl:99:16
   │
99 │   let dx = max(globals.spacing.x, 1e-8);
   │                ^^^^^^^ unknown identifier


    no definition in scope for identifier: 'globals'


_____________________________________________________________ TestTerrainSpikeIntegration.test_debug_uniforms_match_expected_layout _____________________________________________________________ 

self = <test_camera.TestTerrainSpikeIntegration object at 0x0000023E342016E0>

    def test_debug_uniforms_match_expected_layout(self):
        """Test that debug uniforms match expected matrix layout."""
>       spike = vf.TerrainSpike(512, 512)
                ^^^^^^^^^^^^^^^^^^^^^^^^^
E       pyo3_runtime.PanicException: wgpu error: Validation Error
E       
E       Caused by:
E           In Device::create_shader_module
E             note: label = `vf.Terrain.shader`
E
E       Shader 'vf.Terrain.shader' parsing error: no definition in scope for identifier: 'globals'
E          ┌─ wgsl:99:16
E          │
E       99 │   let dx = max(globals.spacing.x, 1e-8);
E          │                ^^^^^^^ unknown identifier
E       
E       
E           no definition in scope for identifier: 'globals'

tests\test_camera.py:267: PanicException
------------------------------------------------------------------------------------- Captured stderr call -------------------------------------------------------------------------------------- 

thread '<unnamed>' panicked at C:\Users\milos\.cargo\registry\src\index.crates.io-1949cf8c6b5b557f\wgpu-0.19.4\src\backend\wgpu_core.rs:3006:5:
wgpu error: Validation Error

Caused by:
    In Device::create_shader_module
      note: label = `vf.Terrain.shader`

Shader 'vf.Terrain.shader' parsing error: no definition in scope for identifier: 'globals'
   ┌─ wgsl:99:16
   │
99 │   let dx = max(globals.spacing.x, 1e-8);
   │                ^^^^^^^ unknown identifier


    no definition in scope for identifier: 'globals'


____________________________________________________________________________ test_terrainspike_default_proj_is_wgpu _____________________________________________________________________________ 

    def test_terrainspike_default_proj_is_wgpu():
        """Test that TerrainSpike defaults to WGPU clip space projection."""
        import numpy as np
        try:
            import vulkan_forge as vf
        except ImportError:
            import _vulkan_forge as vf

        if not hasattr(vf, "TerrainSpike"):
            import pytest
            pytest.skip("TerrainSpike not built")

        W, H = 128, 96
>       t = vf.TerrainSpike(W, H, grid=32)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       pyo3_runtime.PanicException: wgpu error: Validation Error
E       
E       Caused by:
E           In Device::create_shader_module
E             note: label = `vf.Terrain.shader`
E
E       Shader 'vf.Terrain.shader' parsing error: no definition in scope for identifier: 'globals'
E          ┌─ wgsl:99:16
E          │
E       99 │   let dx = max(globals.spacing.x, 1e-8);
E          │                ^^^^^^^ unknown identifier
E       
E       
E           no definition in scope for identifier: 'globals'

tests\test_camera.py:311: PanicException
------------------------------------------------------------------------------------- Captured stderr call -------------------------------------------------------------------------------------- 

thread '<unnamed>' panicked at C:\Users\milos\.cargo\registry\src\index.crates.io-1949cf8c6b5b557f\wgpu-0.19.4\src\backend\wgpu_core.rs:3006:5:
wgpu error: Validation Error

Caused by:
    In Device::create_shader_module
      note: label = `vf.Terrain.shader`

Shader 'vf.Terrain.shader' parsing error: no definition in scope for identifier: 'globals'
   ┌─ wgsl:99:16
   │
99 │   let dx = max(globals.spacing.x, 1e-8);
   │                ^^^^^^^ unknown identifier


    no definition in scope for identifier: 'globals'


______________________________________________________________________ TestColormapLUT.test_terrain_spike_colormap_viridis ______________________________________________________________________ 

self = <test_colormap.TestColormapLUT object at 0x0000023E341EDF90>

    def test_terrain_spike_colormap_viridis(self):
        """Test that TerrainSpike can be created with viridis colormap."""
>       terrain = TerrainSpike(256, 256, grid=64, colormap="viridis")
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       pyo3_runtime.PanicException: wgpu error: Validation Error
E       
E       Caused by:
E           In Device::create_shader_module
E             note: label = `vf.Terrain.shader`
E
E       Shader 'vf.Terrain.shader' parsing error: no definition in scope for identifier: 'globals'
E          ┌─ wgsl:99:16
E          │
E       99 │   let dx = max(globals.spacing.x, 1e-8);
E          │                ^^^^^^^ unknown identifier
E       
E       
E           no definition in scope for identifier: 'globals'

tests\test_colormap.py:26: PanicException
------------------------------------------------------------------------------------- Captured stderr call -------------------------------------------------------------------------------------- 

thread '<unnamed>' panicked at C:\Users\milos\.cargo\registry\src\index.crates.io-1949cf8c6b5b557f\wgpu-0.19.4\src\backend\wgpu_core.rs:3006:5:
wgpu error: Validation Error

Caused by:
    In Device::create_shader_module
      note: label = `vf.Terrain.shader`

Shader 'vf.Terrain.shader' parsing error: no definition in scope for identifier: 'globals'
   ┌─ wgsl:99:16
   │
99 │   let dx = max(globals.spacing.x, 1e-8);
   │                ^^^^^^^ unknown identifier


    no definition in scope for identifier: 'globals'


_______________________________________________________________________ TestColormapLUT.test_terrain_spike_colormap_magma _______________________________________________________________________ 

self = <test_colormap.TestColormapLUT object at 0x0000023E341EE0D0>

    def test_terrain_spike_colormap_magma(self):
        """Test that TerrainSpike can be created with magma colormap."""
>       terrain = TerrainSpike(256, 256, grid=64, colormap="magma")
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       pyo3_runtime.PanicException: wgpu error: Validation Error
E       
E       Caused by:
E           In Device::create_shader_module
E             note: label = `vf.Terrain.shader`
E
E       Shader 'vf.Terrain.shader' parsing error: no definition in scope for identifier: 'globals'
E          ┌─ wgsl:99:16
E          │
E       99 │   let dx = max(globals.spacing.x, 1e-8);
E          │                ^^^^^^^ unknown identifier
E       
E       
E           no definition in scope for identifier: 'globals'

tests\test_colormap.py:31: PanicException
------------------------------------------------------------------------------------- Captured stderr call -------------------------------------------------------------------------------------- 

thread '<unnamed>' panicked at C:\Users\milos\.cargo\registry\src\index.crates.io-1949cf8c6b5b557f\wgpu-0.19.4\src\backend\wgpu_core.rs:3006:5:
wgpu error: Validation Error

Caused by:
    In Device::create_shader_module
      note: label = `vf.Terrain.shader`

Shader 'vf.Terrain.shader' parsing error: no definition in scope for identifier: 'globals'
   ┌─ wgsl:99:16
   │
99 │   let dx = max(globals.spacing.x, 1e-8);
   │                ^^^^^^^ unknown identifier


    no definition in scope for identifier: 'globals'


______________________________________________________________________ TestColormapLUT.test_terrain_spike_colormap_terrain ______________________________________________________________________ 

self = <test_colormap.TestColormapLUT object at 0x0000023E34201940>

    def test_terrain_spike_colormap_terrain(self):
        """Test that TerrainSpike can be created with terrain colormap."""
>       terrain = TerrainSpike(256, 256, grid=64, colormap="terrain")
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       pyo3_runtime.PanicException: wgpu error: Validation Error
E       
E       Caused by:
E           In Device::create_shader_module
E             note: label = `vf.Terrain.shader`
E
E       Shader 'vf.Terrain.shader' parsing error: no definition in scope for identifier: 'globals'
E          ┌─ wgsl:99:16
E          │
E       99 │   let dx = max(globals.spacing.x, 1e-8);
E          │                ^^^^^^^ unknown identifier
E       
E       
E           no definition in scope for identifier: 'globals'

tests\test_colormap.py:36: PanicException
------------------------------------------------------------------------------------- Captured stderr call -------------------------------------------------------------------------------------- 

thread '<unnamed>' panicked at C:\Users\milos\.cargo\registry\src\index.crates.io-1949cf8c6b5b557f\wgpu-0.19.4\src\backend\wgpu_core.rs:3006:5:
wgpu error: Validation Error

Caused by:
    In Device::create_shader_module
      note: label = `vf.Terrain.shader`

Shader 'vf.Terrain.shader' parsing error: no definition in scope for identifier: 'globals'
   ┌─ wgsl:99:16
   │
99 │   let dx = max(globals.spacing.x, 1e-8);
   │                ^^^^^^^ unknown identifier


    no definition in scope for identifier: 'globals'


______________________________________________________________________ TestColormapLUT.test_terrain_spike_default_colormap ______________________________________________________________________ 

self = <test_colormap.TestColormapLUT object at 0x0000023E34201810>

    def test_terrain_spike_default_colormap(self):
        """Test that TerrainSpike defaults to viridis when no colormap specified."""
>       terrain = TerrainSpike(256, 256, grid=64)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       pyo3_runtime.PanicException: wgpu error: Validation Error
E       
E       Caused by:
E           In Device::create_shader_module
E             note: label = `vf.Terrain.shader`
E
E       Shader 'vf.Terrain.shader' parsing error: no definition in scope for identifier: 'globals'
E          ┌─ wgsl:99:16
E          │
E       99 │   let dx = max(globals.spacing.x, 1e-8);
E          │                ^^^^^^^ unknown identifier
E       
E       
E           no definition in scope for identifier: 'globals'

tests\test_colormap.py:41: PanicException
------------------------------------------------------------------------------------- Captured stderr call -------------------------------------------------------------------------------------- 

thread '<unnamed>' panicked at C:\Users\milos\.cargo\registry\src\index.crates.io-1949cf8c6b5b557f\wgpu-0.19.4\src\backend\wgpu_core.rs:3006:5:
wgpu error: Validation Error

Caused by:
    In Device::create_shader_module
      note: label = `vf.Terrain.shader`

Shader 'vf.Terrain.shader' parsing error: no definition in scope for identifier: 'globals'
   ┌─ wgsl:99:16
   │
99 │   let dx = max(globals.spacing.x, 1e-8);
   │                ^^^^^^^ unknown identifier


    no definition in scope for identifier: 'globals'


__________________________________________________________________ TestColormapLUT.test_terrain_spike_colormap_case_sensitive ___________________________________________________________________ 

self = <test_colormap.TestColormapLUT object at 0x0000023E05AE9590>

    def test_terrain_spike_colormap_case_sensitive(self):
        """Test that colormap names are case sensitive."""
        # These should work (lowercase)
>       terrain1 = TerrainSpike(256, 256, grid=64, colormap="viridis")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       pyo3_runtime.PanicException: wgpu error: Validation Error
E       
E       Caused by:
E           In Device::create_shader_module
E             note: label = `vf.Terrain.shader`
E
E       Shader 'vf.Terrain.shader' parsing error: no definition in scope for identifier: 'globals'
E          ┌─ wgsl:99:16
E          │
E       99 │   let dx = max(globals.spacing.x, 1e-8);
E          │                ^^^^^^^ unknown identifier
E       
E       
E           no definition in scope for identifier: 'globals'

tests\test_colormap.py:54: PanicException
------------------------------------------------------------------------------------- Captured stderr call -------------------------------------------------------------------------------------- 

thread '<unnamed>' panicked at C:\Users\milos\.cargo\registry\src\index.crates.io-1949cf8c6b5b557f\wgpu-0.19.4\src\backend\wgpu_core.rs:3006:5:
wgpu error: Validation Error

Caused by:
    In Device::create_shader_module
      note: label = `vf.Terrain.shader`

Shader 'vf.Terrain.shader' parsing error: no definition in scope for identifier: 'globals'
   ┌─ wgsl:99:16
   │
99 │   let dx = max(globals.spacing.x, 1e-8);
   │                ^^^^^^^ unknown identifier


    no definition in scope for identifier: 'globals'


____________________________________________________________________ TestColormapLUT.test_terrain_spike_render_with_colormap ____________________________________________________________________ 

self = <test_colormap.TestColormapLUT object at 0x0000023E342218C0>

    def test_terrain_spike_render_with_colormap(self):
        """Test that terrain can render PNG with different colormaps."""
        import tempfile
        import os

        colormaps = ["viridis", "magma", "terrain"]

        for colormap in colormaps:
>           terrain = TerrainSpike(128, 128, grid=32, colormap=colormap)
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E           pyo3_runtime.PanicException: wgpu error: Validation Error
E
E           Caused by:
E               In Device::create_shader_module
E                 note: label = `vf.Terrain.shader`
E
E           Shader 'vf.Terrain.shader' parsing error: no definition in scope for identifier: 'globals'
E              ┌─ wgsl:99:16
E              │
E           99 │   let dx = max(globals.spacing.x, 1e-8);
E              │                ^^^^^^^ unknown identifier
E
E
E               no definition in scope for identifier: 'globals'

tests\test_colormap.py:75: PanicException
------------------------------------------------------------------------------------- Captured stderr call -------------------------------------------------------------------------------------- 

thread '<unnamed>' panicked at C:\Users\milos\.cargo\registry\src\index.crates.io-1949cf8c6b5b557f\wgpu-0.19.4\src\backend\wgpu_core.rs:3006:5:
wgpu error: Validation Error

Caused by:
    In Device::create_shader_module
      note: label = `vf.Terrain.shader`

Shader 'vf.Terrain.shader' parsing error: no definition in scope for identifier: 'globals'
   ┌─ wgsl:99:16
   │
99 │   let dx = max(globals.spacing.x, 1e-8);
   │                ^^^^^^^ unknown identifier


    no definition in scope for identifier: 'globals'


______________________________________________________________________________ test_terrain_spike_format_selection ______________________________________________________________________________ 

    @pytest.mark.skipif(not TERRAIN_SPIKE_AVAILABLE, reason="terrain_spike feature not enabled")
    def test_terrain_spike_format_selection():
        """Test that TerrainSpike selects the correct format based on environment."""
        import os

        # Test default case: should use sRGB or UNORM format (adapter-dependent)
>       terrain = TerrainSpike(128, 128, grid=32, colormap="viridis")
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       pyo3_runtime.PanicException: wgpu error: Validation Error
E       
E       Caused by:
E           In Device::create_shader_module
E             note: label = `vf.Terrain.shader`
E
E       Shader 'vf.Terrain.shader' parsing error: no definition in scope for identifier: 'globals'
E          ┌─ wgsl:99:16
E          │
E       99 │   let dx = max(globals.spacing.x, 1e-8);
E          │                ^^^^^^^ unknown identifier
E       
E       
E           no definition in scope for identifier: 'globals'

tests\test_colormap.py:146: PanicException
------------------------------------------------------------------------------------- Captured stderr call -------------------------------------------------------------------------------------- 

thread '<unnamed>' panicked at C:\Users\milos\.cargo\registry\src\index.crates.io-1949cf8c6b5b557f\wgpu-0.19.4\src\backend\wgpu_core.rs:3006:5:
wgpu error: Validation Error

Caused by:
    In Device::create_shader_module
      note: label = `vf.Terrain.shader`

Shader 'vf.Terrain.shader' parsing error: no definition in scope for identifier: 'globals'
   ┌─ wgsl:99:16
   │
99 │   let dx = max(globals.spacing.x, 1e-8);
   │                ^^^^^^^ unknown identifier


    no definition in scope for identifier: 'globals'


____________________________________________________________________________ test_terrain_spike_with_unorm_fallback _____________________________________________________________________________ 

    @pytest.mark.skipif(not TERRAIN_SPIKE_AVAILABLE, reason="terrain_spike feature not enabled")
    def test_terrain_spike_with_unorm_fallback():
        """Smoke test for TerrainSpike with UNORM fallback when env var is set."""
        import os
        import tempfile

        # Set environment variable to force UNORM fallback
        old_val = os.environ.get('VF_FORCE_LUT_UNORM')
        try:
            os.environ['VF_FORCE_LUT_UNORM'] = '1'

            # This should work without shader changes
>           terrain = TerrainSpike(128, 128, grid=32, colormap="viridis")
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E           pyo3_runtime.PanicException: wgpu error: Validation Error
E
E           Caused by:
E               In Device::create_shader_module
E                 note: label = `vf.Terrain.shader`
E
E           Shader 'vf.Terrain.shader' parsing error: no definition in scope for identifier: 'globals'
E              ┌─ wgsl:99:16
E              │
E           99 │   let dx = max(globals.spacing.x, 1e-8);
E              │                ^^^^^^^ unknown identifier
E
E
E               no definition in scope for identifier: 'globals'

tests\test_colormap.py:174: PanicException
------------------------------------------------------------------------------------- Captured stderr call -------------------------------------------------------------------------------------- 

thread '<unnamed>' panicked at C:\Users\milos\.cargo\registry\src\index.crates.io-1949cf8c6b5b557f\wgpu-0.19.4\src\backend\wgpu_core.rs:3006:5:
wgpu error: Validation Error

Caused by:
    In Device::create_shader_module
      note: label = `vf.Terrain.shader`

Shader 'vf.Terrain.shader' parsing error: no definition in scope for identifier: 'globals'
   ┌─ wgsl:99:16
   │
99 │   let dx = max(globals.spacing.x, 1e-8);
   │                ^^^^^^^ unknown identifier


    no definition in scope for identifier: 'globals'


_________________________________________________________________________________ test_t31_uniform_lanes_layout _________________________________________________________________________________ 

    def test_t31_uniform_lanes_layout():
        # Small offscreen to exercise pipeline creation
>       spike = vf.TerrainSpike(256, 192, grid=64, colormap="viridis")
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       pyo3_runtime.PanicException: wgpu error: Validation Error
E       
E       Caused by:
E           In Device::create_shader_module
E             note: label = `vf.Terrain.shader`
E
E       Shader 'vf.Terrain.shader' parsing error: no definition in scope for identifier: 'globals'
E          ┌─ wgsl:99:16
E          │
E       99 │   let dx = max(globals.spacing.x, 1e-8);
E          │                ^^^^^^^ unknown identifier
E       
E       
E           no definition in scope for identifier: 'globals'

tests\test_t31_integration.py:15: PanicException
------------------------------------------------------------------------------------- Captured stderr call -------------------------------------------------------------------------------------- 

thread '<unnamed>' panicked at C:\Users\milos\.cargo\registry\src\index.crates.io-1949cf8c6b5b557f\wgpu-0.19.4\src\backend\wgpu_core.rs:3006:5:
wgpu error: Validation Error

Caused by:
    In Device::create_shader_module
      note: label = `vf.Terrain.shader`

Shader 'vf.Terrain.shader' parsing error: no definition in scope for identifier: 'globals'
   ┌─ wgsl:99:16
   │
99 │   let dx = max(globals.spacing.x, 1e-8);
   │                ^^^^^^^ unknown identifier


    no definition in scope for identifier: 'globals'


___________________________________________________________________________________ test_t31_render_png_smoke ___________________________________________________________________________________ 

tmp_path = WindowsPath('C:/Users/milos/AppData/Local/Temp/pytest-of-milos/pytest-66/test_t31_render_png_smoke0')

    def test_t31_render_png_smoke(tmp_path):
>       spike = vf.TerrainSpike(320, 240, grid=64, colormap="viridis")
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       pyo3_runtime.PanicException: wgpu error: Validation Error
E       
E       Caused by:
E           In Device::create_shader_module
E             note: label = `vf.Terrain.shader`
E
E       Shader 'vf.Terrain.shader' parsing error: no definition in scope for identifier: 'globals'
E          ┌─ wgsl:99:16
E          │
E       99 │   let dx = max(globals.spacing.x, 1e-8);
E          │                ^^^^^^^ unknown identifier
E       
E       
E           no definition in scope for identifier: 'globals'

tests\test_t31_integration.py:31: PanicException
------------------------------------------------------------------------------------- Captured stderr call -------------------------------------------------------------------------------------- 

thread '<unnamed>' panicked at C:\Users\milos\.cargo\registry\src\index.crates.io-1949cf8c6b5b557f\wgpu-0.19.4\src\backend\wgpu_core.rs:3006:5:
wgpu error: Validation Error

Caused by:
    In Device::create_shader_module
      note: label = `vf.Terrain.shader`

Shader 'vf.Terrain.shader' parsing error: no definition in scope for identifier: 'globals'
   ┌─ wgsl:99:16
   │
99 │   let dx = max(globals.spacing.x, 1e-8);
   │                ^^^^^^^ unknown identifier


    no definition in scope for identifier: 'globals'


======================================================================================= warnings summary ======================================================================================== 
tests\test_determinism.py:8
  C:\Users\milos\vulkan-forge\tests\test_determinism.py:8: PytestUnknownMarkWarning: Unknown pytest.mark.timeout - is this a typo?  You can register custom marks to avoid this warning - for details, see https://docs.pytest.org/en/stable/how-to/mark.html
    @pytest.mark.timeout(20)

tests\test_determinism.py:21
  C:\Users\milos\vulkan-forge\tests\test_determinism.py:21: PytestUnknownMarkWarning: Unknown pytest.mark.timeout - is this a typo?  You can register custom marks to avoid this warning - for details, see https://docs.pytest.org/en/stable/how-to/mark.html
    @pytest.mark.timeout(20)

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
==================================================================================== short test summary info ==================================================================================== 
FAILED tests/test_api_validation.py::test_terrain_validation - pyo3_runtime.PanicException: wgpu error: Validation Error
FAILED tests/test_camera.py::TestTerrainSpikeIntegration::test_set_camera_look_at_exists - pyo3_runtime.PanicException: wgpu error: Validation Error
FAILED tests/test_camera.py::TestTerrainSpikeIntegration::test_set_camera_look_at_updates_uniforms - pyo3_runtime.PanicException: wgpu error: Validation Error
FAILED tests/test_camera.py::TestTerrainSpikeIntegration::test_set_camera_look_at_validates_parameters - pyo3_runtime.PanicException: wgpu error: Validation Error
FAILED tests/test_camera.py::TestTerrainSpikeIntegration::test_debug_uniforms_match_expected_layout - pyo3_runtime.PanicException: wgpu error: Validation Error
FAILED tests/test_camera.py::test_terrainspike_default_proj_is_wgpu - pyo3_runtime.PanicException: wgpu error: Validation Error
FAILED tests/test_colormap.py::TestColormapLUT::test_terrain_spike_colormap_viridis - pyo3_runtime.PanicException: wgpu error: Validation Error
FAILED tests/test_colormap.py::TestColormapLUT::test_terrain_spike_colormap_magma - pyo3_runtime.PanicException: wgpu error: Validation Error
FAILED tests/test_colormap.py::TestColormapLUT::test_terrain_spike_colormap_terrain - pyo3_runtime.PanicException: wgpu error: Validation Error
FAILED tests/test_colormap.py::TestColormapLUT::test_terrain_spike_default_colormap - pyo3_runtime.PanicException: wgpu error: Validation Error
FAILED tests/test_colormap.py::TestColormapLUT::test_terrain_spike_colormap_case_sensitive - pyo3_runtime.PanicException: wgpu error: Validation Error
FAILED tests/test_colormap.py::TestColormapLUT::test_terrain_spike_render_with_colormap - pyo3_runtime.PanicException: wgpu error: Validation Error
FAILED tests/test_colormap.py::test_terrain_spike_format_selection - pyo3_runtime.PanicException: wgpu error: Validation Error
FAILED tests/test_colormap.py::test_terrain_spike_with_unorm_fallback - pyo3_runtime.PanicException: wgpu error: Validation Error
FAILED tests/test_t31_integration.py::test_t31_uniform_lanes_layout - pyo3_runtime.PanicException: wgpu error: Validation Error
FAILED tests/test_t31_integration.py::test_t31_render_png_smoke - pyo3_runtime.PanicException: wgpu error: Validation Error